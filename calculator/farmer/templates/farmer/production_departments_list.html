{% extends 'base.html' %}

{% block content %}
<div class="row center-xs">
    <div class="col-xs-12">
        <h2>Производственные отделы</h2>
        <div class="search-container">
            <input type="text" id="departmentSearch" onkeyup="searchTable('departmentSearch', 'departmentTable')" placeholder="Поиск отдела...">
        </div>
        <div class="scrollable-table">
            <table id="departmentTable">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Тип продуктов</th>
                        <th>Среднее количество</th>
                    </tr>
                </thead>
                <tbody>
                    {% for department in departments %}
                    <tr>
                        <td>{{ department.name }}</td>
                        <td>{{ department.product_type }}</td>
                        <td>{{ department.average_output }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row center-xs">
    <div class="col-xs-12">
        <h2>Загруженность отделов</h2>
        {% for data in load_data %}
        <div class="department-load">
            <h3>{{ data.department }}</h3>
            <div class="chart-container">
                <canvas id="chart-{{ forloop.counter0 }}"></canvas>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Подключение Chart.js и адаптера даты -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px; /* Уменьшение высоты графиков */
        width: 100%;
        overflow-x: auto; /* Добавление горизонтальной прокрутки */
    }

    .department-load {
        margin-bottom: 20px;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadData = {{ load_data|safe }};
        const startDate = "{{ start_date }}";
        const endDate = "{{ end_date }}";

        loadData.forEach((data, index) => {
            const ctx = document.getElementById(`chart-${index}`).getContext('2d');

            // Подготовка данных для графика
            const datasets = data.load.map((load, idx) => ({
                label: `Заказ ${load.order_id}`,
                data: [{
                    x: load.start_date,
                    y: idx,
                    x2: load.end_date,
                }],
                backgroundColor: getRandomColor(),
                borderColor: getRandomColor(),
                borderWidth: 1,
                barPercentage: 1,
                categoryPercentage: 1,
            }));

            const config = {
                type: 'bar',
                data: {
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                min: startDate,
                                max: endDate
                            },
                            title: {
                                display: true,
                                text: 'Время'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value, index) => `Заказ ${data.load[index]?.order_id || ''}`
                            },
                            title: {
                                display: true,
                                text: 'Заказы'
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            };

            new Chart(ctx, config);
        });

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    });
</script>
{% endblock %}
